define(["exports","./style-settings.js","./style-transformer.js","./style-util.js"],function(_exports,_styleSettings,_styleTransformer,_styleUtil){'use strict';Object.defineProperty(_exports,"__esModule",{value:!0});_exports.getCurrentScope=getCurrentScope;_exports.getOwnerScope=getOwnerScope;_exports.ensureCorrectScope=ensureCorrectScope;_exports.ensureCorrectSubtreeScoping=ensureCorrectSubtreeScoping;_exports.flush=void 0;_styleTransformer=babelHelpers.interopRequireDefault(_styleTransformer);let flush=function(){};_exports.flush=flush;function getClasses(element){if(element.classList&&element.classList.value){return element.classList.value}else{return element.getAttribute("class")||""}}const scopeRegExp=new RegExp(`${_styleTransformer.default.SCOPE_NAME}\\s*([^\\s]*)`);function getCurrentScope(element){const match=getClasses(element).match(scopeRegExp);if(match){return match[1]}else{return""}}function getOwnerScope(node){const ownerRoot=(0,_styleUtil.wrap)(node).getRootNode();if(ownerRoot===node||ownerRoot===node.ownerDocument){return""}const host=ownerRoot.host;if(!host){return""}return(0,_styleUtil.getIsExtends)(host).is}function ensureCorrectScope(element){const currentScope=getCurrentScope(element),ownerRoot=(0,_styleUtil.wrap)(element).getRootNode();if(ownerRoot===element){return}if(currentScope&&ownerRoot===element.ownerDocument){_styleTransformer.default.domRemoveScope(element,currentScope)}else if(ownerRoot instanceof ShadowRoot){const ownerScope=getOwnerScope(element);if(ownerScope!==currentScope){_styleTransformer.default.domReplaceScope(element,currentScope,ownerScope)}}}function ensureCorrectSubtreeScoping(element){const unscopedNodes=window.ShadyDOM.nativeMethods.querySelectorAll.call(element,`:not(.${_styleTransformer.default.SCOPE_NAME})`);for(let j=0;j<unscopedNodes.length;j++){const unscopedNode=unscopedNodes[j],scopeForPreviouslyUnscopedNode=getOwnerScope(unscopedNode);if(scopeForPreviouslyUnscopedNode){_styleTransformer.default.element(unscopedNode,scopeForPreviouslyUnscopedNode)}}}function isElementWithBuiltCss(el){if("style"===el.localName||"template"===el.localName){return(0,_styleUtil.elementHasBuiltCss)(el)}return!1}function handler(mxns){for(let x=0,mxn;x<mxns.length;x++){mxn=mxns[x];if(mxn.target===document.documentElement||mxn.target===document.head){continue}for(let i=0,n;i<mxn.addedNodes.length;i++){n=mxn.addedNodes[i];if(n.nodeType!==Node.ELEMENT_NODE){continue}n=n;let root=n.getRootNode(),currentScope=getCurrentScope(n);if(currentScope&&root===n.ownerDocument&&!isElementWithBuiltCss(n)){_styleTransformer.default.domRemoveScope(n,currentScope)}else if(root instanceof ShadowRoot){const newScope=getOwnerScope(n);if(newScope!==currentScope){_styleTransformer.default.domReplaceScope(n,currentScope,newScope)}ensureCorrectSubtreeScoping(n)}}}}if(!_styleSettings.nativeShadow&&!(window.ShadyDOM&&window.ShadyDOM.handlesDynamicScoping)){let observer=new MutationObserver(handler),start=node=>{observer.observe(node,{childList:!0,subtree:!0})},nativeCustomElements=window.customElements&&!window.customElements.polyfillWrapFlushCallback;if(nativeCustomElements){start(document)}else{let delayedStart=()=>{start(document.body)};if(window.HTMLImports){window.HTMLImports.whenReady(delayedStart)}else{requestAnimationFrame(function(){if("loading"===document.readyState){let listener=function(){delayedStart();document.removeEventListener("readystatechange",listener)};document.addEventListener("readystatechange",listener)}else{delayedStart()}})}}_exports.flush=flush=function(){handler(observer.takeRecords())}}});